---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const formattedDate = post.data.date.toISOString().slice(0, 10);
const { Content, headings } = await post.render();
---
<BaseLayout title={`${post.data.title} — blog`} meta={post.data.description}>
  <article class="flex flex-col gap-4 sm:gap-6 py-6 sm:py-10">
    <div class="flex flex-col gap-1">
      <p class="muted text-sm m-0">{formattedDate}</p>
      <h1 class="m-0">{post.data.title}</h1>
      {post.data.description && <p class="muted m-0">{post.data.description}</p>}
      {post.data.tags.length > 0 && (
        <div class="mt-1 flex flex-wrap gap-2 text-xs">
          {post.data.tags.map((tag) => (
            <span class="px-2 py-1 rounded-full" style="border:1px solid var(--border); color: var(--muted);">
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>

    {post.data.toc && headings.length > 0 && (
      <div class="toc-container" x-data="{ open: true }">
        <div class="toc-header" @click="open = !open">
          <h2 id="概要">概要</h2>
          <span class="toc-toggle" x-text="open ? '▼' : '▶'"></span>
        </div>
        <ul class="toc-list" x-show="open" x-collapse>
          {headings.map((heading) => (
            <li class={`toc-level-${heading.depth}`}>
              <a href={`#${heading.slug}`}>{heading.text}</a>
            </li>
          ))}
        </ul>
      </div>
    )}

    <div class="flex flex-col gap-4 leading-7" style="color: var(--text);">
      <Content />
    </div>
  </article>
</BaseLayout>
