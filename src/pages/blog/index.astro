---
export const prerender = true;
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
const allTags = Array.from(new Set(posts.flatMap((post) => post.data.tags || []))).sort();
const postsData = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description || "",
  dateValue: post.data.date.valueOf(),
  dateStr: post.data.date.toISOString().slice(0, 10),
  tags: post.data.tags || [],
}));
---
<BaseLayout title="Blog — code-onigiri">
  <section class="flex flex-col gap-4 sm:gap-6 py-6 sm:py-10" x-data=`blogFilter(${JSON.stringify(postsData)})`>
    <div>
      <h1>Blog</h1>
      <p class="muted">恐らく、更新されるであろうブログ（）</p>
    </div>

    <div class="flex flex-col gap-4">
      {/* 検索とフィルターコントロール */}
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div class="flex-1">
          <label for="search" class="block text-sm font-medium mb-1">タイトル/説明で検索</label>
          <input
            type="text"
            id="search"
            placeholder="キーワードを入力..."
            x-model="searchQuery"
            class="form-field w-full"
          />
        </div>
        <div>
          <label for="sort" class="block text-sm font-medium mb-1">並び替え</label>
          <select
            id="sort"
            x-model="sortOrder"
            class="form-field form-select"
          >
            <option value="desc">新しい順</option>
            <option value="asc">古い順</option>
          </select>
        </div>
      </div>

      {/* タグフィルター */}
      {allTags.length > 0 && (
        <div>
          <p class="text-sm font-medium mb-2">タグで絞り込む</p>
          <div class="flex flex-wrap gap-2">
            {allTags.map((tag) => (
              <button
                type="button"
                @click={`toggleTag('${tag}')`}
                :class={`selectedTags.includes('${tag}') ? 'tag tag--active' : 'tag tag--inactive'`}
                class="px-3 py-1 rounded-full text-xs transition-colors"
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      )}
    </div>

    <ul class="list-none m-0 p-0 flex flex-col gap-5">
      <template x-for="post in filteredPosts" :key="post.slug">
        <li class="border-b border-[color:var(--border)] pb-4 last:border-b-0 last:pb-0">
          <a class="no-underline" :href="`/blog/${post.slug}/`">
            <div class="text-sm muted" x-text="post.dateStr"></div>
            <h2 class="m-0 text-xl font-semibold" x-text="post.title"></h2>
            <template x-if="post.description">
              <p class="muted m-0" x-text="post.description"></p>
            </template>
          </a>

          <template x-if="post.tags.length > 0">
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <template x-for="tag in post.tags" :key="tag">
                <span class="tag-chip">
                  <span x-text="tag"></span>
                </span>
              </template>
            </div>
          </template>
        </li>
      </template>
    </ul>

    <template x-if="filteredPosts.length === 0">
      <p class="text-center muted py-8">記事が見つかりません</p>
    </template>
  </section>
</BaseLayout>

<script>
  window.blogFilter = function(postsData) {
    return {
      searchQuery: "",
      selectedTags: [],
      sortOrder: "desc",
      allPosts: postsData,

      get filteredPosts() {
        let filtered = [...this.allPosts];

        // タグでフィルター
        if (this.selectedTags.length > 0) {
          filtered = filtered.filter((post) =>
            this.selectedTags.some((tag) => post.tags.includes(tag))
          );
        }

        // 検索クエリでフィルター
        if (this.searchQuery) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(
            (post) =>
              post.title.toLowerCase().includes(query) ||
              post.description.toLowerCase().includes(query)
          );
        }

        // ソート
        const direction = this.sortOrder === "desc" ? -1 : 1;
        filtered.sort((a, b) => (a.dateValue - b.dateValue) * direction);

        return filtered;
      },

      toggleTag(tag) {
        const index = this.selectedTags.indexOf(tag);
        if (index > -1) {
          this.selectedTags.splice(index, 1);
        } else {
          this.selectedTags.push(tag);
        }
      },
    };
  };
</script>
